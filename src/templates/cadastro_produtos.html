{% extends "base.html" %}

{% block title %}Cadastro de Produtos - Sistema de Almoxarifado{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-5 text-center mb-4">
            <i class="bi bi-plus-circle"></i> Cadastro de Produtos
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-box"></i> Informações do Produto
                </h5>
            </div>
            <div class="card-body">
                <form id="form-produto">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="codigo" class="form-label">
                                <i class="bi bi-upc"></i> Código do Produto *
                            </label>
                            <input type="text" class="form-control" id="codigo" name="codigo" required>
                            <div class="form-text">Código único para identificação do produto</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="categoria" class="form-label">
                                <i class="bi bi-tags"></i> Categoria *
                            </label>
                            <select class="form-select" id="categoria" name="categoria" required>
                                <option value="">Selecione a categoria</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nome" class="form-label">
                            <i class="bi bi-box-seam"></i> Nome do Produto *
                        </label>
                        <input type="text" class="form-control" id="nome" name="nome" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao" class="form-label">
                            <i class="bi bi-card-text"></i> Descrição
                        </label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fornecedor" class="form-label">
                                <i class="bi bi-building"></i> Fornecedor
                            </label>
                            <select class="form-select" id="fornecedor" name="fornecedor">
                                <option value="">Selecione o fornecedor</option>
                                <!-- Fornecedores serão carregados dinamicamente -->
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="local_produto" class="form-label">
                                <i class="bi bi-geo-alt"></i> Local do Produto
                            </label>
                            <input type="text" class="form-control" id="local_produto" name="local_produto" 
                                   placeholder="Ex: A1-01, B2.05, C-3">
                            <div class="form-text">Aceita números, pontos, hífens e letras</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="preco" class="form-label">
                                <i class="bi bi-currency-dollar"></i> Preço (R$)
                            </label>
                            <input type="number" class="form-control" id="preco" name="preco" 
                                   step="0.01" min="0" value="0.00">
                            <div class="form-text">Opcional - padrão R$ 0,00</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="quantidade_estoque" class="form-label">
                                <i class="bi bi-archive"></i> Quantidade Inicial
                            </label>
                            <input type="number" class="form-control" id="quantidade_estoque" 
                                   name="quantidade_estoque" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="limparFormulario()">
                            <i class="bi bi-arrow-clockwise"></i> Limpar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Cadastrar Produto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Produtos Recém Cadastrados -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> Produtos Recém Cadastrados
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Fornecedor</th>
                                <th>Local</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Data Cadastro</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-recentes">
                            <tr>
                                <td colspan="8" class="text-center">Carregando produtos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarProdutosRecentes();
    carregarCategorias();
    carregarFornecedores();
    
    // Configurar formulário
    document.getElementById('form-produto').addEventListener('submit', cadastrarProduto);
    
    // Validação em tempo real do código
    document.getElementById('codigo').addEventListener('blur', validarCodigo);
});

async function carregarCategorias() {
    try {
        const response = await fetch('/api/categorias');
        const categorias = await response.json();
        
        if (response.ok) {
            const select = document.getElementById('categoria');
            select.innerHTML = '<option value="">Selecione a categoria</option>';
            
            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.nome;
                option.textContent = categoria.nome;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

async function carregarFornecedores() {
    try {
        const response = await fetch('/api/fornecedores');
        const fornecedores = await response.json();
        
        if (response.ok) {
            const select = document.getElementById('fornecedor');
            select.innerHTML = '<option value="">Selecione o fornecedor</option>';
            
            fornecedores.forEach(fornecedor => {
                const option = document.createElement('option');
                option.value = fornecedor.nome;
                option.textContent = fornecedor.nome;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar fornecedores:', error);
    }
}

async function cadastrarProduto(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const produto = Object.fromEntries(formData.entries());
    
    // Validações
    if (!produto.codigo.trim()) {
        showAlert('Código do produto é obrigatório', 'warning');
        return;
    }
    
    if (!produto.nome.trim()) {
        showAlert('Nome do produto é obrigatório', 'warning');
        return;
    }
    
    if (!produto.categoria) {
        showAlert('Categoria é obrigatória', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/produtos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(produto)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Produto cadastrado com sucesso!', 'success');
            limparFormulario();
            carregarProdutosRecentes();
        } else {
            showAlert('Erro ao cadastrar produto: ' + data.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro de conexão: ' + error.message, 'danger');
    }
}

async function validarCodigo() {
    const codigo = document.getElementById('codigo').value.trim();
    if (!codigo) return;
    
    try {
        const response = await fetch(`/api/produtos?busca=${encodeURIComponent(codigo)}`);
        const produtos = await response.json();
        
        const produtoExistente = produtos.find(p => p.codigo.toLowerCase() === codigo.toLowerCase());
        if (produtoExistente) {
            showAlert('Código já existe! Produto: ' + produtoExistente.nome, 'warning');
            document.getElementById('codigo').focus();
        }
    } catch (error) {
        console.error('Erro ao validar código:', error);
    }
}

async function carregarProdutosRecentes() {
    try {
        const response = await fetch('/api/produtos');
        const produtos = await response.json();
        
        if (response.ok) {
            // Ordenar por data de cadastro (mais recentes primeiro) e pegar os 10 primeiros
            const produtosRecentes = produtos
                .sort((a, b) => new Date(b.data_cadastro) - new Date(a.data_cadastro))
                .slice(0, 10);
            
            atualizarTabelaProdutos(produtosRecentes);
        } else {
            showAlert('Erro ao carregar produtos: ' + produtos.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro de conexão: ' + error.message, 'danger');
    }
}

function atualizarTabelaProdutos(produtos) {
    const tbody = document.getElementById('produtos-recentes');
    tbody.innerHTML = '';
    
    if (produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum produto cadastrado</td></tr>';
        return;
    }
    
    produtos.forEach(produto => {
        const tr = document.createElement('tr');
        
        let badgeCategoria = 'bg-primary';
        if (produto.categoria.toLowerCase().includes('a')) badgeCategoria = 'bg-danger';
        else if (produto.categoria.toLowerCase().includes('b')) badgeCategoria = 'bg-warning';
        else if (produto.categoria.toLowerCase().includes('c')) badgeCategoria = 'bg-success';
        
        tr.innerHTML = `
            <td><strong>${produto.codigo}</strong></td>
            <td>${produto.nome}</td>
            <td><span class="badge ${badgeCategoria}">${produto.categoria}</span></td>
            <td>${produto.fornecedor || '-'}</td>
            <td>${produto.local_produto || '-'}</td>
            <td>${formatCurrency(produto.preco)}</td>
            <td>
                <span class="badge ${produto.quantidade_estoque > 0 ? 'bg-success' : 'bg-secondary'}">
                    ${produto.quantidade_estoque}
                </span>
            </td>
            <td>${formatDate(produto.data_cadastro)}</td>
        `;
        
        tbody.appendChild(tr);
    });
}

function limparFormulario() {
    document.getElementById('form-produto').reset();
    document.getElementById('preco').value = '0.00';
    document.getElementById('quantidade_estoque').value = '0';
    document.getElementById('codigo').focus();
}

// Focar no primeiro campo ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('codigo').focus();
});
</script>
{% endblock %}

