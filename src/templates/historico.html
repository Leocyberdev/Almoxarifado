{% extends "base.html" %}

{% block title %}Histórico - Sistema de Almoxarifado{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-5 text-center mb-4">
            <i class="bi bi-clock-history"></i> Histórico de Movimentações
        </h1>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> Filtros de Pesquisa
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="filtro-periodo" class="form-label">Período</label>
                        <select class="form-select" id="filtro-periodo">
                            <option value="dia">Último dia</option>
                            <option value="semana" selected>Última semana</option>
                            <option value="mes">Último mês</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="filtro-funcionario" class="form-label">Funcionário</label>
                        <input type="text" class="form-control" id="filtro-funcionario" 
                               placeholder="Nome do funcionário">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="filtro-produto" class="form-label">Código do Produto</label>
                        <input type="text" class="form-control" id="filtro-produto" 
                               placeholder="Código do produto">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="filtro-obra" class="form-label">Número da Obra</label>
                        <input type="text" class="form-control" id="filtro-obra" 
                               placeholder="Número da obra">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="filtro-tipo" class="form-label">Tipo de Movimentação</label>
                        <select class="form-select" id="filtro-tipo">
                            <option value="">Todos os tipos</option>
                            <option value="ALOCACAO">Alocação</option>
                            <option value="ENTRADA">Entrada</option>
                            <option value="SAIDA">Saída</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="data-inicio" class="form-label">Data Início</label>
                        <input type="date" class="form-control" id="data-inicio">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="data-fim" class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="data-fim">
                    </div>
                    
                    <div class="col-md-3 mb-3 d-flex align-items-end">
                        <div class="d-grid gap-2 w-100">
                            <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="bi bi-arrow-clockwise"></i> Limpar Filtros
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportarHistorico()">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumo -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h4 id="total-movimentacoes">0</h4>
                <p class="mb-0">Total de Movimentações</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h4 id="total-alocacoes">0</h4>
                <p class="mb-0">Alocações</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h4 id="total-entradas">0</h4>
                <p class="mb-0">Entradas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h4 id="valor-total">R$ 0,00</h4>
                <p class="mb-0">Valor Total</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Movimentações -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Movimentações
                </h5>
                <span class="badge bg-primary" id="contador-movimentacoes">0 movimentações</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                                <th>Obra</th>
                                <th>Funcionário</th>
                                <th>Observações</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-movimentacoes">
                            <tr>
                                <td colspan="10" class="text-center">Carregando movimentações...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginação -->
                <nav aria-label="Paginação">
                    <ul class="pagination justify-content-center" id="paginacao">
                        <!-- Paginação será gerada dinamicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Detalhes da Movimentação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-detalhes-body">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let movimentacoesCarregadas = [];
let paginaAtual = 1;
const itensPorPagina = 20;

document.addEventListener('DOMContentLoaded', function() {
    carregarMovimentacoes();
    configurarFiltros();
});

async function carregarMovimentacoes() {
    try {
        const periodo = document.getElementById('filtro-periodo').value;
        const response = await fetch(`/api/historico?periodo=${periodo}`);
        const movimentacoes = await response.json();
        
        if (response.ok) {
            movimentacoesCarregadas = movimentacoes;
            aplicarFiltros();
            atualizarResumo(movimentacoes);
        } else {
            showAlert('Erro ao carregar movimentações: ' + movimentacoes.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro de conexão: ' + error.message, 'danger');
    }
}

function aplicarFiltros() {
    const funcionario = document.getElementById('filtro-funcionario').value.toLowerCase();
    const produto = document.getElementById('filtro-produto').value.toLowerCase();
    const obra = document.getElementById('filtro-obra').value.toLowerCase();
    const tipo = document.getElementById('filtro-tipo').value;
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    
    let movimentacoesFiltradas = movimentacoesCarregadas.filter(mov => {
        const matchFuncionario = !funcionario || 
            (mov.funcionario && mov.funcionario.nome.toLowerCase().includes(funcionario));
        const matchProduto = !produto || 
            (mov.produto && mov.produto.codigo.toLowerCase().includes(produto));
        const matchObra = !obra || 
            (mov.obra && mov.obra.numero_obra.toLowerCase().includes(obra));
        const matchTipo = !tipo || mov.tipo_movimentacao === tipo;
        
        let matchData = true;
        if (dataInicio || dataFim) {
            const dataMovimentacao = new Date(mov.data_movimentacao).toISOString().split('T')[0];
            if (dataInicio && dataMovimentacao < dataInicio) matchData = false;
            if (dataFim && dataMovimentacao > dataFim) matchData = false;
        }
        
        return matchFuncionario && matchProduto && matchObra && matchTipo && matchData;
    });
    
    atualizarTabela(movimentacoesFiltradas);
    atualizarContador(movimentacoesFiltradas.length);
    atualizarResumo(movimentacoesFiltradas);
}

function atualizarTabela(movimentacoes) {
    const tbody = document.getElementById('tabela-movimentacoes');
    tbody.innerHTML = '';
    
    if (movimentacoes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhuma movimentação encontrada</td></tr>';
        return;
    }
    
    // Ordenar por data (mais recentes primeiro)
    movimentacoes.sort((a, b) => new Date(b.data_movimentacao) - new Date(a.data_movimentacao));
    
    // Paginação
    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const movimentacoesPagina = movimentacoes.slice(inicio, fim);
    
    movimentacoesPagina.forEach(mov => {
        const tr = document.createElement('tr');
        
        let badgeTipo = 'bg-primary';
        if (mov.tipo_movimentacao === 'ALOCACAO') badgeTipo = 'bg-success';
        else if (mov.tipo_movimentacao === 'SAIDA') badgeTipo = 'bg-warning';
        else if (mov.tipo_movimentacao === 'ENTRADA') badgeTipo = 'bg-info';
        
        tr.innerHTML = `
            <td>${formatDate(mov.data_movimentacao)}</td>
            <td><span class="badge ${badgeTipo}">${mov.tipo_movimentacao}</span></td>
            <td>
                <strong>${mov.produto ? mov.produto.codigo : 'N/A'}</strong><br>
                <small class="text-muted">${mov.produto ? mov.produto.nome : 'N/A'}</small>
            </td>
            <td><strong>${mov.quantidade}</strong></td>
            <td>${formatCurrency(mov.valor_unitario)}</td>
            <td><strong>${formatCurrency(mov.valor_total)}</strong></td>
            <td>${mov.obra ? mov.obra.numero_obra : '-'}</td>
            <td>${mov.funcionario ? mov.funcionario.nome : 'N/A'}</td>
            <td>${mov.observacoes ? 
                (mov.observacoes.length > 30 ? 
                    mov.observacoes.substring(0, 30) + '...' : 
                    mov.observacoes) : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes(${mov.id})">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
    
    criarPaginacao(movimentacoes.length);
}

function atualizarResumo(movimentacoes) {
    const total = movimentacoes.length;
    const alocacoes = movimentacoes.filter(m => m.tipo_movimentacao === 'ALOCACAO').length;
    const entradas = movimentacoes.filter(m => m.tipo_movimentacao === 'ENTRADA').length;
    const valorTotal = movimentacoes.reduce((sum, m) => sum + (m.valor_total || 0), 0);
    
    document.getElementById('total-movimentacoes').textContent = total;
    document.getElementById('total-alocacoes').textContent = alocacoes;
    document.getElementById('total-entradas').textContent = entradas;
    document.getElementById('valor-total').textContent = formatCurrency(valorTotal);
}

function atualizarContador(total) {
    document.getElementById('contador-movimentacoes').textContent = 
        `${total} movimentaç${total !== 1 ? 'ões' : 'ão'}`;
}

function criarPaginacao(totalItens) {
    const totalPaginas = Math.ceil(totalItens / itensPorPagina);
    const paginacao = document.getElementById('paginacao');
    paginacao.innerHTML = '';
    
    if (totalPaginas <= 1) return;
    
    // Botão anterior
    const anterior = document.createElement('li');
    anterior.className = `page-item ${paginaAtual === 1 ? 'disabled' : ''}`;
    anterior.innerHTML = '<a class="page-link" href="#" onclick="mudarPagina(' + (paginaAtual - 1) + ')">Anterior</a>';
    paginacao.appendChild(anterior);
    
    // Números das páginas
    for (let i = 1; i <= totalPaginas; i++) {
        const item = document.createElement('li');
        item.className = `page-item ${i === paginaAtual ? 'active' : ''}`;
        item.innerHTML = `<a class="page-link" href="#" onclick="mudarPagina(${i})">${i}</a>`;
        paginacao.appendChild(item);
    }
    
    // Botão próximo
    const proximo = document.createElement('li');
    proximo.className = `page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}`;
    proximo.innerHTML = '<a class="page-link" href="#" onclick="mudarPagina(' + (paginaAtual + 1) + ')">Próximo</a>';
    paginacao.appendChild(proximo);
}

function mudarPagina(pagina) {
    paginaAtual = pagina;
    aplicarFiltros();
}

function configurarFiltros() {
    // Aplicar filtros quando período mudar
    document.getElementById('filtro-periodo').addEventListener('change', function() {
        carregarMovimentacoes();
    });
    
    // Aplicar filtros quando Enter for pressionado
    const inputs = ['filtro-funcionario', 'filtro-produto', 'filtro-obra'];
    inputs.forEach(inputId => {
        document.getElementById(inputId).addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                aplicarFiltros();
            }
        });
    });
    
    // Aplicar filtros quando tipo mudar
    document.getElementById('filtro-tipo').addEventListener('change', aplicarFiltros);
    
    // Aplicar filtros quando datas mudarem
    document.getElementById('data-inicio').addEventListener('change', aplicarFiltros);
    document.getElementById('data-fim').addEventListener('change', aplicarFiltros);
}

function verDetalhes(movimentacaoId) {
    const movimentacao = movimentacoesCarregadas.find(m => m.id === movimentacaoId);
    if (!movimentacao) return;
    
    const modalBody = document.getElementById('modal-detalhes-body');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informações da Movimentação</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>${movimentacao.id}</td></tr>
                    <tr><td><strong>Tipo:</strong></td><td><span class="badge bg-primary">${movimentacao.tipo_movimentacao}</span></td></tr>
                    <tr><td><strong>Data/Hora:</strong></td><td>${formatDate(movimentacao.data_movimentacao)}</td></tr>
                    <tr><td><strong>Quantidade:</strong></td><td>${movimentacao.quantidade}</td></tr>
                    <tr><td><strong>Valor Unitário:</strong></td><td>${formatCurrency(movimentacao.valor_unitario)}</td></tr>
                    <tr><td><strong>Valor Total:</strong></td><td><strong>${formatCurrency(movimentacao.valor_total)}</strong></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Dados Relacionados</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Produto:</strong></td>
                        <td>${movimentacao.produto ? 
                            `${movimentacao.produto.codigo} - ${movimentacao.produto.nome}` : 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Obra:</strong></td>
                        <td>${movimentacao.obra ? 
                            `${movimentacao.obra.numero_obra} - ${movimentacao.obra.nome_obra}` : 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Funcionário:</strong></td>
                        <td>${movimentacao.funcionario ? 
                            `${movimentacao.funcionario.nome} - ${movimentacao.funcionario.cargo}` : 'N/A'}</td>
                    </tr>
                </table>
            </div>
        </div>
        ${movimentacao.observacoes ? 
            `<div class="mt-3">
                <h6>Observações</h6>
                <p class="bg-light p-3 rounded">${movimentacao.observacoes}</p>
            </div>` : ''}
    `;
    
    new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
}

function limparFiltros() {
    document.getElementById('filtro-funcionario').value = '';
    document.getElementById('filtro-produto').value = '';
    document.getElementById('filtro-obra').value = '';
    document.getElementById('filtro-tipo').value = '';
    document.getElementById('data-inicio').value = '';
    document.getElementById('data-fim').value = '';
    paginaAtual = 1;
    aplicarFiltros();
}

function exportarHistorico() {
    // Implementar exportação (CSV, Excel, etc.)
    showAlert('Funcionalidade de exportação em desenvolvimento', 'info');
}
</script>
{% endblock %}

