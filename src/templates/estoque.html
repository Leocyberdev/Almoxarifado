{% extends "base.html" %}

{% block title %}Estoque - Sistema de Almoxarifado{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-5 text-center mb-4">
            <i class="bi bi-archive"></i> Controle de Estoque
        </h1>
    </div>
</div>

<!-- Filtros e Busca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> Filtros e Busca
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filtro-categoria" class="form-label">Categoria</label>
                        <select class="form-select" id="filtro-categoria">
                            <option value="">Todas as categorias</option>
                            <!-- Categorias serão carregadas dinamicamente -->
                        </select>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="filtro-fornecedor" class="form-label">Fornecedor</label>
                        <div class="search-container">
                            <input type="text" class="form-control" id="filtroFornecedor" placeholder="Filtrar por fornecedor" autocomplete="off">
                            <div class="search-results" id="fornecedoresResults"></div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="busca-produto" class="form-label">Busca Inteligente</label>
                        <div class="search-container">
                            <input type="text" class="form-control" id="busca-produto"
                                   placeholder="Digite código ou nome do produto">
                            <div class="search-results" id="search-results"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="bi bi-arrow-clockwise"></i> Limpar
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportarEstoque()">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumo do Estoque -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h4 id="total-produtos">0</h4>
                <p class="mb-0">Total de Produtos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h4 id="produtos-estoque">0</h4>
                <p class="mb-0">Com Estoque</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h4 id="produtos-baixo">0</h4>
                <p class="mb-0">Estoque Baixo</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <h4 id="produtos-zerado">0</h4>
                <p class="mb-0">Estoque Zerado</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Produtos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Lista de Produtos
                </h5>
                <span class="badge bg-primary" id="contador-produtos">0 produtos</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Fornecedor</th>
                                <th>Local</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-produtos">
                            <tr>
                                <td colspan="10" class="text-center">Carregando produtos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                <nav aria-label="Paginação">
                    <ul class="pagination justify-content-center" id="paginacao">
                        <!-- Paginação será gerada dinamicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Produto -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Detalhes do Produto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-detalhes-body">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="irParaAlocacao()">
                    <i class="bi bi-arrow-right-circle"></i> Alocar Produto
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let produtosCarregados = [];
let produtoSelecionado = null;
let paginaAtual = 1;
const itensPorPagina = 20;

document.addEventListener('DOMContentLoaded', function() {
    carregarProdutos();
    carregarCategorias();
    configurarBuscaInteligente();
    configurarBuscaFornecedor();
});

async function carregarCategorias() {
    try {
        const response = await fetch('/api/categorias');
        const categorias = await response.json();

        if (response.ok) {
            const select = document.getElementById('filtro-categoria');
            // Limpar opções existentes (exceto a primeira)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // Adicionar categorias ativas
            categorias.filter(cat => cat.ativa).forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.nome;
                option.textContent = categoria.nome;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

async function carregarProdutos() {
    try {
        const response = await fetch('/api/produtos');
        const produtos = await response.json();

        if (response.ok) {
            produtosCarregados = produtos;
            aplicarFiltros();
            atualizarResumo(produtos);
        } else {
            showAlert('Erro ao carregar produtos: ' + produtos.error, 'danger');
        }
    } catch (error) {
        showAlert('Erro de conexão: ' + error.message, 'danger');
    }
}

function aplicarFiltros() {
    const categoria = document.getElementById('filtro-categoria').value;
    const fornecedor = document.getElementById('filtroFornecedor').value.toLowerCase(); // Alterado para ler do novo input
    const busca = document.getElementById('busca-produto').value.toLowerCase();

    let produtosFiltrados = produtosCarregados.filter(produto => {
        const matchCategoria = !categoria || produto.categoria.toLowerCase().includes(categoria.toLowerCase());
        const matchFornecedor = !fornecedor || produto.fornecedor.toLowerCase().includes(fornecedor);
        const matchBusca = !busca ||
            produto.nome.toLowerCase().includes(busca) ||
            produto.codigo.toLowerCase().includes(busca) ||
            produto.descricao.toLowerCase().includes(busca);

        return matchCategoria && matchFornecedor && matchBusca;
    });

    atualizarTabela(produtosFiltrados);
    atualizarContador(produtosFiltrados.length);
}

function atualizarTabela(produtos) {
    const tbody = document.getElementById('tabela-produtos');
    tbody.innerHTML = '';

    if (produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhum produto encontrado</td></tr>';
        return;
    }

    // Paginação
    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const produtosPagina = produtos.slice(inicio, fim);

    produtosPagina.forEach(produto => {
        const tr = document.createElement('tr');

        let badgeCategoria = 'bg-primary';
        if (produto.categoria.toLowerCase().includes('a')) badgeCategoria = 'bg-danger';
        else if (produto.categoria.toLowerCase().includes('b')) badgeCategoria = 'bg-warning';
        else if (produto.categoria.toLowerCase().includes('c')) badgeCategoria = 'bg-success';

        let statusEstoque = '';
        let badgeEstoque = '';
        if (produto.quantidade_estoque === 0) {
            statusEstoque = 'Zerado';
            badgeEstoque = 'bg-danger';
        } else if (produto.quantidade_estoque <= 10) {
            statusEstoque = 'Baixo';
            badgeEstoque = 'bg-warning';
        } else {
            statusEstoque = 'Normal';
            badgeEstoque = 'bg-success';
        }

        tr.innerHTML = `
            <td><strong>${produto.codigo}</strong></td>
            <td>${produto.nome}</td>
            <td>${produto.descricao || '-'}</td>
            <td><span class="badge ${badgeCategoria}">${produto.categoria}</span></td>
            <td>${produto.fornecedor || '-'}</td>
            <td>${produto.local_produto || '-'}</td>
            <td>${formatCurrency(produto.preco)}</td>
            <td><strong>${produto.quantidade_estoque}</strong></td>
            <td><span class="badge ${badgeEstoque}">${statusEstoque}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes(${produto.id})">
                    <i class="bi bi-eye"></i>
                </button>
                ${produto.quantidade_estoque > 0 ?
                    `<button class="btn btn-sm btn-outline-success" onclick="alocarProduto(${produto.id})" title="Alocar Produto">
                        <i class="bi bi-arrow-right-circle"></i>
                    </button>` :
                    `<button class="btn btn-sm btn-secondary" onclick="showAlert('Produto sem estoque para alocação', 'warning')" title="Sem estoque">
                        <i class="bi bi-arrow-right-circle"></i>
                    </button>`
                }
            </td>
        `;

        tbody.appendChild(tr);
    });

    criarPaginacao(produtos.length);
}

function atualizarResumo(produtos) {
    const total = produtos.length;
    const comEstoque = produtos.filter(p => p.quantidade_estoque > 0).length;
    const baixoEstoque = produtos.filter(p => p.quantidade_estoque > 0 && p.quantidade_estoque <= 10).length;
    const zerado = produtos.filter(p => p.quantidade_estoque === 0).length;

    document.getElementById('total-produtos').textContent = total;
    document.getElementById('produtos-estoque').textContent = comEstoque;
    document.getElementById('produtos-baixo').textContent = baixoEstoque;
    document.getElementById('produtos-zerado').textContent = zerado;
}

function atualizarContador(total) {
    document.getElementById('contador-produtos').textContent = `${total} produto${total !== 1 ? 's' : ''}`;
}

function criarPaginacao(totalItens) {
    const totalPaginas = Math.ceil(totalItens / itensPorPagina);
    const paginacao = document.getElementById('paginacao');
    paginacao.innerHTML = '';

    if (totalPaginas <= 1) return;

    // Botão anterior
    const anterior = document.createElement('li');
    anterior.className = `page-item ${paginaAtual === 1 ? 'disabled' : ''}`;
    anterior.innerHTML = '<a class="page-link" href="#" onclick="mudarPagina(' + (paginaAtual - 1) + ')">Anterior</a>';
    paginacao.appendChild(anterior);

    // Números das páginas
    for (let i = 1; i <= totalPaginas; i++) {
        const item = document.createElement('li');
        item.className = `page-item ${i === paginaAtual ? 'active' : ''}`;
        item.innerHTML = `<a class="page-link" href="#" onclick="mudarPagina(${i})">${i}</a>`;
        paginacao.appendChild(item);
    }

    // Botão próximo
    const proximo = document.createElement('li');
    proximo.className = `page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}`;
    proximo.innerHTML = '<a class="page-link" href="#" onclick="mudarPagina(' + (paginaAtual + 1) + ')">Próximo</a>';
    paginacao.appendChild(proximo);
}

function mudarPagina(pagina) {
    paginaAtual = pagina;
    aplicarFiltros();
}

function configurarBuscaInteligente() {
    const input = document.getElementById('busca-produto');
    const results = document.getElementById('search-results');

    input.addEventListener('input', async function() {
        const termo = this.value.trim();

        if (termo.length < 2) {
            results.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/busca/produtos?q=${encodeURIComponent(termo)}`);
            const produtos = await response.json();

            if (response.ok) {
                mostrarResultadosBusca(produtos);
            }
        } catch (error) {
            console.error('Erro na busca:', error);
        }
    });

    // Fechar resultados ao clicar fora
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !results.contains(e.target)) {
            results.style.display = 'none';
        }
    });
}

function mostrarResultadosBusca(produtos) {
    const results = document.getElementById('search-results');
    results.innerHTML = '';

    if (produtos.length === 0) {
        results.innerHTML = '<div class="search-item">Nenhum produto encontrado</div>';
    } else {
        produtos.forEach(produto => {
            const item = document.createElement('div');
            item.className = 'search-item';
            item.innerHTML = `
                <strong>${produto.codigo}</strong> - ${produto.nome}<br>
                <small class="text-muted">Estoque: ${produto.estoque} | Preço: ${formatCurrency(produto.preco)}</small>
            `;
            item.onclick = function() {
                document.getElementById('busca-produto').value = produto.codigo;
                results.style.display = 'none';
                aplicarFiltros();
            };
            results.appendChild(item);
        });
    }

    results.style.display = 'block';
}

function verDetalhes(produtoId) {
    const produto = produtosCarregados.find(p => p.id === produtoId);
    if (!produto) return;

    produtoSelecionado = produto;

    const modalBody = document.getElementById('modal-detalhes-body');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informações Básicas</h6>
                <table class="table table-sm">
                    <tr><td><strong>Código:</strong></td><td>${produto.codigo}</td></tr>
                    <tr><td><strong>Nome:</strong></td><td>${produto.nome}</td></tr>
                    <tr><td><strong>Categoria:</strong></td><td><span class="badge bg-primary">${produto.categoria}</span></td></tr>
                    <tr><td><strong>Fornecedor:</strong></td><td>${produto.fornecedor || '-'}</td></tr>
                    <tr><td><strong>Local:</strong></td><td>${produto.local_produto || '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Estoque e Preços</h6>
                <table class="table table-sm">
                    <tr><td><strong>Quantidade:</strong></td><td><span class="badge bg-info">${produto.quantidade_estoque}</span></td></tr>
                    <tr><td><strong>Preço:</strong></td><td>${formatCurrency(produto.preco)}</td></tr>
                    <tr><td><strong>Valor Total:</strong></td><td>${formatCurrency(produto.preco * produto.quantidade_estoque)}</td></tr>
                    <tr><td><strong>Cadastrado:</strong></td><td>${formatDate(produto.data_cadastro)}</td></tr>
                </table>
            </div>
        </div>
        ${produto.descricao ? `<div class="mt-3"><h6>Descrição</h6><p>${produto.descricao}</p></div>` : ''}
    `;

    new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
}

function alocarProduto(produtoId) {
    // Redirecionar para página de alocação com produto pré-selecionado
    window.location.href = `/produtos/alocar?produto=${produtoId}`;
}

function irParaAlocacao() {
    if (produtoSelecionado) {
        window.location.href = `/produtos/alocar?produto=${produtoSelecionado.id}`;
    }
}

function limparFiltros() {
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtroFornecedor').value = ''; // Limpar o novo input de fornecedor
    document.getElementById('busca-produto').value = '';
    document.getElementById('search-results').style.display = 'none';
    document.getElementById('fornecedoresResults').style.display = 'none'; // Esconder resultados de fornecedor
    paginaAtual = 1;
    aplicarFiltros();
}

function exportarEstoque() {
    // Fazer download do arquivo CSV
    window.location.href = '/api/estoque/exportar';
    showAlert('Exportação iniciada! O download será iniciado automaticamente.', 'success');
}

// Configuração do autocomplete para fornecedores
function configurarBuscaFornecedor() {
    let timeoutFornecedor;
    const inputFornecedor = document.getElementById('filtroFornecedor');
    const resultsDiv = document.getElementById('fornecedoresResults');

    inputFornecedor.addEventListener('input', function() {
        const termo = this.value.trim();

        clearTimeout(timeoutFornecedor);

        if (termo.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        timeoutFornecedor = setTimeout(async () => {
            try {
                const response = await fetch(`/api/fornecedores/busca?q=${encodeURIComponent(termo)}`);
                const fornecedores = await response.json();

                resultsDiv.innerHTML = ''; // Limpa resultados anteriores
                if (fornecedores.length > 0) {
                    fornecedores.forEach(fornecedor => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.innerHTML = `
                            <strong>${fornecedor.nome}</strong>
                            ${fornecedor.cnpj ? `<br><small class="text-muted">${fornecedor.cnpj}</small>` : ''}
                        `;
                        item.onclick = function() {
                            selecionarFornecedor(fornecedor.nome);
                        };
                        resultsDiv.appendChild(item);
                    });
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="search-item text-muted">Nenhum fornecedor encontrado</div>';
                    resultsDiv.style.display = 'block';
                }

            } catch (error) {
                console.error('Erro ao buscar fornecedores:', error);
                resultsDiv.style.display = 'none';
            }
        }, 300);
    });

    // Fechar resultados ao clicar fora do input ou da área de resultados
    document.addEventListener('click', function(e) {
        if (!inputFornecedor.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
}

function selecionarFornecedor(nome) {
    document.getElementById('filtroFornecedor').value = nome;
    document.getElementById('fornecedoresResults').style.display = 'none';
    aplicarFiltros(); // Chama aplicarFiltros após selecionar o fornecedor
}


// Aplicar filtros quando Enter for pressionado
document.getElementById('filtro-fornecedor').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        aplicarFiltros();
    }
});

document.getElementById('busca-produto').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('search-results').style.display = 'none';
        aplicarFiltros();
    }
});

// Helper para formatar moeda (exemplo)
function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

// Helper para formatar datas (exemplo)
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

// Helper para mostrar alertas (exemplo, assumindo que você tem uma função para isso)
function showAlert(message, type) {
    const alertPlaceholder = document.createElement('div');
    alertPlaceholder.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('content').prepend(alertPlaceholder); // Adiciona no topo do conteúdo
}

</script>
{% endblock %}