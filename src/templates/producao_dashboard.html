
{% extends "base.html" %}

{% block title %}Dashboard - Produção{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-speedometer2"></i> Dashboard da Produção</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="stats-card">
                            <div class="stats-number" id="produtosDisponiveis">0</div>
                            <div class="stats-label">Produtos Disponíveis</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="stats-card">
                            <div class="stats-number" id="produtosAlocados">0</div>
                            <div class="stats-label">Produtos Alocados Hoje</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="stats-card">
                            <div class="stats-number" id="obrasAtivas">0</div>
                            <div class="stats-label">Obras Ativas</div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="stats-card">
                            <div class="stats-number" id="valorTotal">R$ 0,00</div>
                            <div class="stats-label">Valor Total em Estoque</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-archive"></i> Produtos em Estoque</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Estoque</th>
                                <th>Valor Unit.</th>
                            </tr>
                        </thead>
                        <tbody id="produtosTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Últimas Movimentações</h5>
            </div>
            <div class="card-body">
                <div id="ultimasMovimentacoes">
                    <p class="text-center">Carregando...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarDashboard();
});

async function carregarDashboard() {
    try {
        // Carregar estatísticas
        const statsResponse = await fetch('/api/dashboard/stats');
        const stats = await statsResponse.json();
        
        document.getElementById('produtosDisponiveis').textContent = stats.total_produtos || 0;
        document.getElementById('produtosAlocados').textContent = stats.produtos_alocados_hoje || 0;
        document.getElementById('obrasAtivas').textContent = stats.obras_ativas || 0;
        document.getElementById('valorTotal').textContent = formatCurrency(stats.valor_total_estoque || 0);
        
        // Carregar produtos
        const produtosResponse = await fetch('/api/produtos?limit=10');
        const produtos = await produtosResponse.json();
        
        const tbody = document.getElementById('produtosTableBody');
        if (produtos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum produto encontrado</td></tr>';
        } else {
            tbody.innerHTML = produtos.map(produto => `
                <tr>
                    <td>${produto.codigo}</td>
                    <td>${produto.nome}</td>
                    <td>${produto.categoria || '-'}</td>
                    <td>
                        <span class="badge ${produto.quantidade_estoque > 0 ? 'bg-success' : 'bg-danger'}">
                            ${produto.quantidade_estoque}
                        </span>
                    </td>
                    <td>${formatCurrency(produto.preco)}</td>
                </tr>
            `).join('');
        }
        
        // Carregar últimas movimentações
        const movResponse = await fetch('/api/historico?limit=5');
        const movimentacoes = await movResponse.json();
        
        const movContainer = document.getElementById('ultimasMovimentacoes');
        if (movimentacoes.length === 0) {
            movContainer.innerHTML = '<p class="text-center text-muted">Nenhuma movimentação encontrada</p>';
        } else {
            movContainer.innerHTML = movimentacoes.map(mov => `
                <div class="border-bottom pb-2 mb-2">
                    <small class="text-muted">${formatDate(mov.data_movimentacao)}</small>
                    <div>
                        <strong>${mov.produto_nome}</strong>
                        <span class="badge bg-primary">${mov.tipo_movimentacao}</span>
                    </div>
                    <div class="text-muted">Qtd: ${mov.quantidade} | ${mov.obra_nome}</div>
                </div>
            `).join('');
        }
        
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        showAlert('Erro ao carregar dados do dashboard', 'danger');
    }
}
</script>
{% endblock %}
